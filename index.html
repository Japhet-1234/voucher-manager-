
<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HotspotMtaani Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background-color: #f5f4f2;
            color: #443c39;
            font-family: "Calibri", "Candara", "Segoe UI", "Optima", "Arial", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .active-tab {
            color: #5d4037 !important;
            border-bottom: 3px solid #5d4037 !important;
        }
        .receipt-card {
            background: white;
            position: relative;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e3e1;
        }
        .receipt-card::after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: linear-gradient(-45deg, transparent 5px, white 5px), linear-gradient(45deg, transparent 5px, white 5px);
            background-size: 10px 10px;
        }
        .copy-toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #5d4037;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #8d6e63;
            cursor: pointer;
        }
        .btn-active:active { transform: scale(0.95); }
        .code-display:hover { color: #8d6e63; }
    </style>
</head>
<body class="pb-20">

    <div id="toast" class="copy-toast">Risiti Imenakiliwa!</div>

    <div id="loader" class="fixed inset-0 bg-white flex items-center justify-center z-[9999]">
        <div class="text-center">
            <div class="w-10 h-10 border-4 border-[#8d6e63] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-[12px] font-bold uppercase tracking-widest text-stone-400">HOTSPOT MTAANI</p>
        </div>
    </div>

    <div id="app-shell" class="hidden">
        <header class="bg-white border-b-2 border-stone-200 sticky top-0 z-50">
            <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="bg-[#5d4037] p-2 rounded text-white">
                        <i data-lucide="wifi" class="w-5 h-5"></i>
                    </div>
                    <h1 class="font-bold text-sm uppercase tracking-tight text-[#5d4037]">MTAANI ADMIN</h1>
                </div>
                <nav class="flex gap-4 h-full items-center">
                    <button id="nav-home" class="text-[10px] font-bold uppercase tracking-widest px-1 active-tab">STOCK</button>
                    <button id="nav-expired" class="text-[10px] font-bold uppercase tracking-widest px-1 text-stone-400">HISTORY</button>
                    <button id="nav-settings" class="text-[10px] font-bold uppercase tracking-widest px-1 text-stone-400">SETUP</button>
                </nav>
            </div>
        </header>

        <main id="main-content" class="max-w-md mx-auto p-4 space-y-6">
            <!-- Content injected by JS -->
        </main>
    </div>

    <script>
        const STORAGE_KEY = 'hotspot_mtaani_v11_sequential';
        const SEQ_KEY = 'hotspot_mtaani_pointer';
        const PORTAL_URL = 'https://japhet-1234.github.io/hotspotmtaani/';
        const SHARED_ENDPOINT = 'https://api.example.com/vouchers/sync';

        const BUNDLES = [
            { id: 'b1', name: 'SAA 1 (High Speed)', price: 200, minutes: 60 },
            { id: 'b2', name: 'SAA 6 UNLIMITED', price: 500, minutes: 360 },
            { id: 'b3', name: 'SAA 24 UNLIMITED', price: 1000, minutes: 1440 },
            { id: 'b4', name: 'WIKI 1 UNLIMITED', price: 5000, minutes: 10080 }
        ];

        let state = {
            vouchers: [],
            activeTab: 'home',
            selectedBundleId: 'b1',
            batchSize: 5,
            isSyncing: false,
            pointer: { p: 0, n: 1, s: 0 }
        };

        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) state.vouchers = JSON.parse(data) || [];
                const ptr = localStorage.getItem(SEQ_KEY);
                if (ptr) state.pointer = JSON.parse(ptr);
            } catch (e) { 
                state.vouchers = []; 
                state.pointer = { p: 0, n: 1, s: 0 };
            }
        }

        function saveData() {
            try { 
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.vouchers)); 
                localStorage.setItem(SEQ_KEY, JSON.stringify(state.pointer));
            } catch (e) {}
        }

        async function generateSHA256(text) {
            const msgBuffer = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function pushToSharedDatabase(voucherArray) {
            console.log("Pushing JSON to Shared Database...", voucherArray);
            state.isSyncing = true;
            render();
            try {
                await new Promise(r => setTimeout(r, 800));
            } finally {
                state.isSyncing = false;
                render();
            }
        }

        function getNextCode() {
            const prefix = String.fromCharCode(65 + state.pointer.p); 
            const num = String(state.pointer.n).padStart(4, '0'); 
            const suffix = String.fromCharCode(97 + state.pointer.s); 
            const code = `${prefix}-${num}${suffix}`;

            state.pointer.s++;
            if (state.pointer.s > 25) {
                state.pointer.s = 0;
                state.pointer.n++;
            }
            if (state.pointer.n > 9999) {
                state.pointer.n = 1;
                state.pointer.p++;
            }
            if (state.pointer.p > 25) {
                state.pointer.p = 0; 
            }
            return code;
        }

        async function createBatch() {
            const bundle = BUNDLES.find(b => b.id === state.selectedBundleId);
            if (!bundle) return;
            const newVouchers = [];
            const syncPayload = [];
            for (let i = 0; i < state.batchSize; i++) {
                const code = getNextCode();
                const alreadyUsed = state.vouchers.some(v => v.code === code);
                if (alreadyUsed) { i--; continue; }
                const vid = "V-" + Math.random().toString(36).substr(2, 6).toUpperCase();
                const hash = await generateSHA256(vid + code);
                const vObj = {
                    id: vid,
                    voucher_id: vid,
                    amount: bundle.price,
                    hash_key: hash,
                    code: code,
                    bundleName: bundle.name,
                    duration: bundle.minutes,
                    price: bundle.price,
                    status: 'available',
                    createdAt: Date.now()
                };
                newVouchers.push(vObj);
                syncPayload.push({
                    voucher_id: vObj.voucher_id,
                    amount: vObj.amount,
                    hash_key: vObj.hash_key
                });
            }
            state.vouchers = [...state.vouchers, ...newVouchers];
            saveData();
            render();
            pushToSharedDatabase(syncPayload);
        }

        async function copyVoucher(id) {
            const v = state.vouchers.find(x => x.id === id);
            if (!v) return;
            const receiptText = `--- HOTSPOT MTAANI ---\nRISITI YA VOCHA\n----------------------\nKODI: ${v.code}\nMUDA: ${v.bundleName}\nBEI: Tzs ${v.price.toLocaleString()}\n----------------------\nPORTAL: ${PORTAL_URL}\n----------------------\nID: ${v.voucher_id}\nASANTE KWA KUCHAGUA MTAANI!`;
            try {
                await navigator.clipboard.writeText(receiptText);
                showToast("IMENAKILIWA!");
            } catch (err) {
                const el = document.createElement('textarea');
                el.value = receiptText;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                showToast("IMENAKILIWA!");
            }
        }

        async function activateAndOpen(id) {
            const v = state.vouchers.find(x => x.id === id);
            if (!v) return;
            if (confirm(`Kuanzisha vocha ${v.code}?`)) {
                await copyVoucher(id);
                const now = Date.now();
                state.vouchers = state.vouchers.map(x => x.id === id ? {
                    ...x,
                    status: 'active',
                    activatedAt: now,
                    expiresAt: now + (x.duration * 60000)
                } : x);
                saveData();
                render();
                window.open(PORTAL_URL, '_blank');
            }
        }

        function deleteVoucher(id) {
            if (confirm("Futa vocha hii?")) {
                state.vouchers = state.vouchers.filter(v => v.id !== id);
                saveData();
                render();
            }
        }

        function getTimeLeft(expiresAt) {
            if (!expiresAt) return "";
            const diff = expiresAt - Date.now();
            if (diff <= 0) return "IMEISHA";
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            return h > 0 ? `${h}h ${m}m` : `${m}m ${s}s`;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function render() {
            const container = document.getElementById('main-content');
            if (!container) return;
            document.getElementById('nav-home').className = `text-[10px] font-bold uppercase tracking-widest px-1 ${state.activeTab==='home'?'active-tab':'text-stone-400'}`;
            document.getElementById('nav-expired').className = `text-[10px] font-bold uppercase tracking-widest px-1 ${state.activeTab==='expired'?'active-tab':'text-stone-400'}`;
            document.getElementById('nav-settings').className = `text-[10px] font-bold uppercase tracking-widest px-1 ${state.activeTab==='settings'?'active-tab':'text-stone-400'}`;
            if (state.activeTab === 'home') renderHome(container);
            else if (state.activeTab === 'expired') renderExpired(container);
            else renderSettings(container);
            if (window.lucide) window.lucide.createIcons();
        }

        function renderHome(container) {
            const available = state.vouchers.filter(v => v.status === 'available');
            const active = state.vouchers.filter(v => v.status === 'active');
            const revenue = state.vouchers.filter(v => v.status !== 'available').reduce((s, v) => s + (v.price || 0), 0);
            container.innerHTML = `
                <div class="flex justify-between items-end border-b border-stone-300 pb-3">
                    <div>
                        <p class="text-[10px] font-bold text-stone-400 uppercase">Vocha Mpya</p>
                        <h2 class="text-3xl font-bold text-[#5d4037]">${available.length}</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] font-bold text-stone-400 uppercase">Mapato</p>
                        <h2 class="text-xl font-bold text-[#8d6e63]">${revenue.toLocaleString()} TZS</h2>
                    </div>
                </div>
                <div class="bg-stone-200 p-5 rounded-xl border border-stone-300 space-y-4 shadow-sm relative">
                    ${state.isSyncing ? `<div class="absolute top-2 right-2 flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span class="text-[8px] font-bold text-green-600 uppercase">Syncing...</span></div>` : ''}
                    <p class="text-[11px] font-bold uppercase tracking-wide text-[#5d4037]">Mfululizo: ${String.fromCharCode(65+state.pointer.p)}-${String(state.pointer.n).padStart(4,'0')}${String.fromCharCode(97+state.pointer.s)}</p>
                    <select id="bundle-sel" class="w-full bg-white border-2 border-stone-300 p-3 text-sm font-bold rounded-lg outline-none focus:border-[#8d6e63]">
                        ${BUNDLES.map(b => `<option value="${b.id}" ${state.selectedBundleId === b.id ? 'selected' : ''}>${b.name} - ${b.price}Tzs</option>`).join('')}
                    </select>
                    <div class="flex items-center gap-4 py-2">
                        <input id="batch-range" type="range" min="1" max="20" value="${state.batchSize}" class="flex-grow h-2 bg-stone-300 rounded appearance-none cursor-pointer">
                        <span class="text-sm font-bold text-[#5d4037] w-6" id="range-val">${state.batchSize}</span>
                    </div>
                    <button onclick="createBatch()" class="w-full bg-[#5d4037] text-white font-bold py-3.5 rounded-xl text-[12px] uppercase tracking-widest shadow-lg btn-active transition-all">Chapisha kwa Mfululizo</button>
                </div>
                <div class="space-y-3">
                    <p class="text-[10px] font-bold text-stone-400 uppercase border-b border-stone-200 pb-1">Zinazotumika (${active.length})</p>
                    ${active.length === 0 ? '<p class="text-center py-4 text-stone-300 text-[11px] italic">Zilizotumika zitaonekana hapa...</p>' : 
                    active.map(v => `
                        <div class="bg-white border-l-4 border-[#8d6e63] p-4 flex justify-between items-center shadow-sm rounded-r-lg cursor-pointer hover:bg-stone-50 transition-colors" onclick="copyVoucher('${v.id}')">
                            <div>
                                <p class="text-xl font-bold text-[#5d4037] tracking-wider">${v.code}</p>
                                <p class="text-[9px] text-stone-400 font-bold uppercase">${v.bundleName}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-bold text-[#8d6e63]">${getTimeLeft(v.expiresAt)}</p>
                                <p class="text-[8px] text-stone-300 uppercase">Bakia</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="space-y-5">
                    <p class="text-[10px] font-bold text-stone-400 uppercase border-b border-stone-200 pb-1">Stock Iliyopo (${available.length})</p>
                    <div class="space-y-8">
                        ${available.length === 0 ? '<p class="text-center py-10 text-stone-300 text-[11px] italic uppercase">Hamna vocha mpya</p>' : 
                        available.map(v => `
                            <div class="receipt-card space-y-4">
                                <div class="text-center border-b border-dashed border-stone-200 pb-4">
                                    <h3 class="text-sm font-bold tracking-tight text-[#5d4037]">HOTSPOT MTAANI</h3>
                                    <p class="text-[7px] text-stone-400 font-mono">HASH: ${v.hash_key.substring(0, 16)}...</p>
                                </div>
                                <div class="py-2 flex flex-col items-center">
                                    <p class="text-[10px] font-bold text-stone-300 uppercase">Kodi ya Vocha (Bofya Kunakili)</p>
                                    <div onclick="copyVoucher('${v.id}')" class="text-3xl font-bold tracking-[0.1em] text-[#5d4037] cursor-pointer code-display transition-colors">
                                        ${v.code}
                                    </div>
                                    <p class="text-[11px] font-bold text-stone-600 mt-1 uppercase">${v.bundleName}</p>
                                </div>
                                <div class="border-t border-dashed border-stone-200 pt-4 flex justify-between items-center">
                                    <button onclick="deleteVoucher('${v.id}')" class="text-stone-300 hover:text-red-400 p-1">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                    <button onclick="activateAndOpen('${v.id}')" class="bg-[#8d6e63] text-white text-[10px] font-bold px-5 py-2.5 rounded-lg uppercase shadow btn-active">
                                        Fungua Portal
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('bundle-sel').onchange = (e) => state.selectedBundleId = e.target.value;
            document.getElementById('batch-range').oninput = (e) => {
                state.batchSize = e.target.value;
                document.getElementById('range-val').innerText = e.target.value;
            };
        }

        function renderExpired(container) {
            const expired = state.vouchers.filter(v => v.status === 'expired');
            container.innerHTML = `
                <div class="bg-white border-2 border-stone-200 rounded-xl overflow-hidden shadow-sm">
                    <div class="p-4 bg-stone-100 border-b-2 border-stone-200 flex justify-between items-center">
                        <h2 class="text-[11px] font-bold uppercase tracking-widest text-[#5d4037]">Zilizotumika / Zilizoisha</h2>
                        <button onclick="clearExpired()" class="text-[#8d6e63] text-[11px] font-bold uppercase hover:underline">Futa Zote</button>
                    </div>
                    <div class="divide-y divide-stone-50">
                        ${expired.length === 0 ? '<p class="p-12 text-center text-stone-300 text-[11px] italic">Historia ni safi...</p>' : 
                        expired.map(v => `
                            <div class="p-4 flex justify-between items-center opacity-40 grayscale">
                                <div>
                                    <span class="text-base font-bold line-through text-stone-800">${v.code}</span>
                                    <p class="text-[8px] font-bold uppercase text-stone-500">${v.bundleName}</p>
                                </div>
                                <span class="text-[9px] font-bold text-stone-400 uppercase">Imetumika</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderSettings(container) {
            container.innerHTML = `
                <div class="bg-white border-2 border-stone-200 p-8 text-center space-y-6 rounded-xl shadow-sm">
                    <div class="w-16 h-16 bg-stone-100 rounded-full flex items-center justify-center mx-auto text-[#5d4037]">
                        <i data-lucide="layers" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-sm font-bold uppercase tracking-widest text-[#5d4037]">SEQUENTIAL ENGINE v11</h2>
                    <div class="text-left bg-stone-50 p-5 space-y-3 border border-stone-200 rounded-lg">
                        <div class="flex justify-between items-center text-[10px]">
                            <span class="font-bold text-stone-400 uppercase">Next Code:</span>
                            <span class="font-bold text-[#5d4037]">${String.fromCharCode(65+state.pointer.p)}-${String(state.pointer.n).padStart(4,'0')}${String.fromCharCode(97+state.pointer.s)}</span>
                        </div>
                        <div class="flex justify-between items-center text-[10px]">
                            <span class="font-bold text-stone-400 uppercase">Duplicate Shield:</span>
                            <span class="text-green-600 font-bold uppercase">Active</span>
                        </div>
                    </div>
                    <button onclick="factoryReset()" class="w-full bg-stone-100 text-stone-400 py-4 rounded-xl font-bold text-[11px] uppercase tracking-widest border border-stone-200 hover:bg-red-50 hover:text-red-400 btn-active transition-all">
                        Reset All Counters
                    </button>
                </div>
            `;
        }

        function clearExpired() {
            if(confirm("Futa historia yote?")) {
                state.vouchers = state.vouchers.filter(v => v.status !== 'expired');
                saveData();
                render();
            }
        }

        function factoryReset() {
            if(confirm("Hii itafuta data zote na kuanza upya na A-0001a. Je, una uhakika?")) {
                localStorage.clear();
                location.reload();
            }
        }

        window.onload = () => {
            loadData();
            document.getElementById('loader').style.display = 'none';
            document.getElementById('app-shell').classList.remove('hidden');
            render();
            document.getElementById('nav-home').onclick = () => { state.activeTab = 'home'; render(); };
            document.getElementById('nav-expired').onclick = () => { state.activeTab = 'expired'; render(); };
            document.getElementById('nav-settings').onclick = () => { state.activeTab = 'settings'; render(); };
            setInterval(() => {
                const now = Date.now();
                let changed = false;
                state.vouchers = state.vouchers.map(v => {
                    if (v.status === 'active' && v.expiresAt && now > v.expiresAt) {
                        changed = true;
                        return { ...v, status: 'expired' };
                    }
                    return v;
                });
                if (changed) { saveData(); render(); }
            }, 5000);
        };
    </script>
</body>
</html>
